<%# TODO: This is a hack to persist the selected active state of the chat when conversation is intervened. Ideally we should find a way to do this with turbo frames/streams %>
<li id="conversation_item_<%= conversation.id %>"
    class="hover:bg-gray-50 cursor-pointer w-full <%= conversation.intervention_enabled? ? 'bg-base-300 border-r-4 border-info' : '' %>"
    data-active-chat-target="item" 
    data-action="click->active-chat#selectChat">
  <%= link_to chatbot_conversation_path(conversation.chatbot_id, conversation.id),
      class: "p-4 flex items-center justify-between",
      data: { turbo_frame: "_top", turbo_stream: true, turbo_prefetch: "false" } do %>

    <div class="flex-grow">
      <div class="flex gap-1">
        <div class="relative" id="chat_interface_chat_list_item_warning_frame">
          <% if conversation.intervention_enabled? %>
            <span class="absolute top-[-8px] left-[-8px] flex size-3">
              <span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-error"></span>
              <span class="relative inline-flex size-3 rounded-full bg-warning"></span>
            </span>
          <% end %>
          <h3 class="text-lg font-medium">
            <%= conversation.contact&.name || "+#{conversation.contact&.phone_number}" %>
          </h3>
        </div>
      </div>

      <div class="flex items-center text-sm text-gray-500">
        <% if conversation.latest_message_status.present? %>
          <div class="relative w-6 h-4">
            <% if conversation.latest_message_status.sent? %>
              <%= icon "check", variant: "outline", class: "size-4 absolute top-0 left-0 text-gray-500" %>
            <% elsif conversation.latest_message_status.delivered? %>
              <%= icon "check", variant: "outline", class: "size-4 absolute top-0 left-0 text-gray-500" %>
              <%= icon "check", variant: "outline", class: "size-4 absolute top-0 left-1 text-gray-500" %>
            <% elsif conversation.latest_message_status.read? %>
              <%= icon "check", variant: "outline", class: "size-4 absolute top-0 left-0 text-blue-500" %>
              <%= icon "check", variant: "outline", class: "size-4 absolute top-0 left-1 text-blue-500" %>
            <% elsif conversation.latest_message_status.failed? %>
              <%= icon "x-mark", variant: "outline", class: "size-4 absolute top-0 left-0 text-red-500" %>
            <% end %>
          </div>
        <% end %>
        <p class="text-sm truncate"><%= conversation.latest_message_content&.truncate(32) %></p>
      </div>
    </div>

    <span class="text-xs text-gray-400"><%= last_message_timestamp(conversation.latest_message_at, conversation.chatbot.timezone) %></span>
  <% end %>
</li>