<% content_for :sub_navigation do %>
  <%= render "shared/chatbot_header" %>
<% end %>

<div class="breadcrumbs mb-8">
  <ul>
    <li>
      <%= link_to root_path do %>
        Home
      <% end %>
    </li>
    <li>
      <%= link_to chatbot_integrations_path(@chatbot), class: "link link-hover" do %>
        Integrations
      <% end %>
    </li>
    <li>
      Instagram
    </li>
  </ul>
</div>

<!-- Settings heading -->
<h1 class="text-3xl font-bold mb-8 flex gap-2 items-center">
  <%= image_tag "https://conversalo.nyc3.cdn.digitaloceanspaces.com/ig.svg", class: "w-12 h-12 mr-2" %>
  <span>Instagram</span>
</h1>

<% raw_profile = @me.respond_to?(:parsed_response) ? @me.parsed_response : (@me || {}) %>
<% profile_data = raw_profile.is_a?(Hash) ? raw_profile : {} %>
<% error_message = if profile_data["error"].is_a?(Hash)
                     profile_data.dig("error", "message")
                   else
                     profile_data["error"].presence
                   end %>
<% fallback_username = profile_data["username"].presence || "Unavailable" %>
<% profile_fields = [
  { label: "Name", value: profile_data["name"] },
  { label: "Username", value: profile_data["username"] },
  { label: "User ID", value: profile_data["user_id"] || @instagram_channel&.instagram_id },
  { label: "Account Type", value: profile_data["account_type"] }
] %>

<div class="flex-1 space-y-8">
  <% if error_message.present? %>
    <div class="alert alert-warning shadow-md">
      <span>We could not refresh your Instagram profile details. <%= error_message %></span>
      <span class="text-sm">You can still manage the integration below.</span>
    </div>
  <% end %>

  <div class="card bg-base-100 shadow-xl border border-base-200">
    <div class="card-body">
      <div class="flex flex-wrap items-center gap-6">
        <div class="avatar">
          <div class="w-24 h-24 rounded-full bg-base-200 ring ring-primary ring-offset-base-100 ring-offset-2 overflow-hidden">
            <%= image_tag(profile_data["profile_picture_url"].presence || "https://conversalo.nyc3.cdn.digitaloceanspaces.com/ig.svg", alt: "#{fallback_username} avatar", class: "w-full h-full object-cover") %>
          </div>
        </div>
        <div class="space-y-1">
          <h2 class="card-title text-3xl">
            <%= profile_data["name"].presence || fallback_username %>
          </h2>
          <p class="text-base-content/70 text-lg">@<%= fallback_username %></p>
          <p class="text-sm text-base-content/60">Connected ID: <%= profile_data["user_id"].presence || @instagram_channel&.instagram_id %></p>
        </div>
      </div>

      <div class="divider my-8"></div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <% profile_fields.each do |field| %>
          <div class="bg-base-200/80 rounded-2xl p-5 border border-base-200">
            <p class="text-xs uppercase tracking-wide text-base-content/60"><%= field[:label] %></p>
            <p class="text-lg font-semibold text-base-content mt-1 break-all">
              <%= field[:value].presence || "Not available" %>
            </p>
          </div>
        <% end %>
      </div>

      <div class="card-actions justify-end mt-10">
        <%= button_to "Disconnect", chatbot_integrations_instagram_path(@chatbot), method: :delete, class: "btn btn-error focus:outline-none focus-visible:ring focus-visible:ring-error/50", data: { turbo_confirm: "Disconnect this Instagram account from Odichat?", turbo_submits_with: "Disconnecting..." } %>
      </div>
    </div>
  </div>
</div>
